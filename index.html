<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crowders Creek Excavation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;600;700&family=Roboto+Mono:wght@400;700&display=swap');

        :root {
            --dig-yellow: #fbbf24;
            --dig-dark: #1f2937;
            --dig-slate: #374151;
            --dig-green: #10b981;
            --dig-red: #ef4444;
        }

        body {
            font-family: 'Chakra Petch', sans-serif;
            background-color: #111827;
            color: #f3f4f6;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        .font-mono {
            font-family: 'Roboto Mono', monospace;
        }

        /* CRT Screen Effect */
        .screen-container {
            background: radial-gradient(circle, #374151 0%, #1f2937 100%);
            border: 4px solid #4b5563;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.8), inset 0 0 50px rgba(0,0,0,0.5);
            position: relative;
            overflow: hidden;
        }

        .scanline {
            width: 100%;
            height: 100px;
            z-index: 10;
            background: linear-gradient(0deg, rgba(0,0,0,0) 0%, rgba(255, 255, 255, 0.02) 50%, rgba(0,0,0,0) 100%);
            opacity: 0.1;
            position: absolute;
            bottom: 100%;
            animation: scanline 10s linear infinite;
            pointer-events: none;
        }

        @keyframes scanline {
            0% { bottom: 100%; }
            100% { bottom: -100%; }
        }

        .btn-dig {
            background: linear-gradient(180deg, #f59e0b 0%, #d97706 100%);
            border-bottom: 4px solid #b45309;
            transition: all 0.1s;
        }
        .btn-dig:active {
            transform: translateY(2px);
            border-bottom: 0px solid #b45309;
        }

        .btn-secondary {
            background: linear-gradient(180deg, #4b5563 0%, #374151 100%);
            border-bottom: 4px solid #1f2937;
            transition: all 0.1s;
        }
        .btn-secondary:active {
            transform: translateY(2px);
            border-bottom: 0px solid #1f2937;
        }

        /* Map Zone Styles */
        .map-zone {
            transition: all 0.3s;
            cursor: pointer;
        }
        .map-zone:hover {
            filter: drop-shadow(0 0 10px var(--dig-yellow));
            transform: scale(1.02);
        }
        .zone-locked {
            filter: grayscale(1) brightness(0.5);
            cursor: not-allowed;
        }
        
        .game-canvas {
            touch-action: none;
            image-rendering: pixelated;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; 
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; 
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; 
        }
        
        /* Table Styles for Lab */
        .lab-table th, .lab-table td {
            border: 1px solid #4b5563;
            padding: 0.5rem;
            text-align: left;
            font-size: 0.85rem;
        }
        .lab-table th {
            background-color: #374151;
            color: #fbbf24;
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col p-2 md:p-4">

    <!-- Header -->
    <header class="flex justify-between items-center mb-4 bg-gray-900 p-4 rounded-lg border-2 border-gray-700 shadow-lg">
        <div class="flex items-center gap-3">
            <i class="fas fa-mountain text-yellow-500 text-3xl"></i>
            <div>
                <h1 class="text-xl md:text-2xl font-bold text-yellow-500 uppercase tracking-wider">Crowders Creek Excavation</h1>
                <p class="text-xs text-gray-400 font-mono">SC-GEO-EDU-UNIT-6 // AUTH: SILAS</p>
            </div>
        </div>
        <div class="text-right hidden md:block">
            <p class="text-sm text-gray-400">STATUS: <span id="systemStatus" class="text-green-400 font-bold">ONLINE</span></p>
            <p class="text-sm text-gray-400">LOCATION: CLOVER, SC</p>
        </div>
    </header>

    <!-- Main Content Area -->
    <main id="mainContainer" class="flex-1 screen-container rounded-xl relative flex flex-col">
        <div class="scanline"></div>
        
        <!-- VIEW: DASHBOARD (MAP) -->
        <div id="view-dashboard" class="absolute inset-0 p-6 flex flex-col items-center justify-center">
            <h2 class="text-2xl mb-6 text-center text-white border-b-2 border-yellow-500 pb-2 w-full max-w-4xl">SELECT EXCAVATION SITE</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-5xl h-full overflow-y-auto">
                
                <!-- Game 1: The Lab (Gateway) -->
                <div onclick="app.launchGame(1)" class="map-zone bg-gray-800 p-6 rounded-lg border-2 border-blue-500 relative group overflow-hidden">
                    <div class="absolute top-0 right-0 bg-blue-600 text-white text-xs font-bold px-2 py-1">REQUIRED FIRST</div>
                    <div class="flex items-center gap-4 mb-3">
                        <div class="w-12 h-12 bg-blue-900 rounded-full flex items-center justify-center text-blue-300 text-2xl">
                            <i class="fas fa-flask"></i>
                        </div>
                        <h3 class="text-xl font-bold text-blue-300">Site A: Field Lab</h3>
                    </div>
                    <p class="text-gray-400 text-sm mb-4">Analyze core samples using density calculation. Essential data collection before mining begins.</p>
                    <div class="flex justify-between items-center">
                        <span id="badge-lab" class="text-xs font-mono bg-gray-900 px-2 py-1 rounded text-gray-500">STATUS: PENDING</span>
                        <button class="btn-secondary px-4 py-1 rounded text-sm text-white">ENTER LAB</button>
                    </div>
                </div>

                <!-- Game 2: Mineral Properties -->
                <div id="card-game2" onclick="app.launchGame(2)" class="map-zone zone-locked bg-gray-800 p-6 rounded-lg border-2 border-yellow-600 relative">
                    <div class="flex items-center gap-4 mb-3">
                        <div class="w-12 h-12 bg-yellow-900 rounded-full flex items-center justify-center text-yellow-300 text-2xl">
                            <i class="fas fa-gem"></i>
                        </div>
                        <h3 class="text-xl font-bold text-yellow-500">Site B: The Sorting Belt</h3>
                    </div>
                    <p class="text-gray-400 text-sm mb-4">Analyze properties on the conveyor. Classify by definition (Luster vs Cleavage).</p>
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-mono text-gray-400">HIGH SCORE: <span id="score-g2">0</span></span>
                        <i class="fas fa-lock text-gray-500 lock-icon"></i>
                    </div>
                </div>

                <!-- Game 3: Rock Cycle -->
                <div id="card-game3" onclick="app.launchGame(3)" class="map-zone zone-locked bg-gray-800 p-6 rounded-lg border-2 border-red-600 relative">
                    <div class="flex items-center gap-4 mb-3">
                        <div class="w-12 h-12 bg-red-900 rounded-full flex items-center justify-center text-red-300 text-2xl">
                            <i class="fas fa-volcano"></i>
                        </div>
                        <h3 class="text-xl font-bold text-red-500">Site C: Magma Run</h3>
                    </div>
                    <p class="text-gray-400 text-sm mb-4">Navigate the Rock Cycle. Classify processes (Weathering, Cooling) rapidly.</p>
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-mono text-gray-400">HIGH SCORE: <span id="score-g3">0</span></span>
                        <i class="fas fa-lock text-gray-500 lock-icon"></i>
                    </div>
                </div>

                <!-- Game 4: Hardness Scale -->
                <div id="card-game4" onclick="app.launchGame(4)" class="map-zone zone-locked bg-gray-800 p-6 rounded-lg border-2 border-purple-600 relative">
                    <div class="flex items-center gap-4 mb-3">
                        <div class="w-12 h-12 bg-purple-900 rounded-full flex items-center justify-center text-purple-300 text-2xl">
                            <i class="fas fa-hammer"></i>
                        </div>
                        <h3 class="text-xl font-bold text-purple-500">Site D: Mohs Drill</h3>
                    </div>
                    <p class="text-gray-400 text-sm mb-4">Use the Mohs Hardness Scale to drill through layers. Maintain the perfect pressure!</p>
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-mono text-gray-400">HIGH SCORE: <span id="score-g4">0</span></span>
                        <i class="fas fa-lock text-gray-500 lock-icon"></i>
                    </div>
                </div>

            </div>
        </div>

        <!-- VIEW: QUIZ INTERFACE -->
        <div id="view-quiz" class="absolute inset-0 bg-gray-900 z-20 hidden flex flex-col items-center justify-center p-4">
            <!-- Decreased max width to max-w-lg -->
            <div class="bg-gray-800 p-6 rounded-xl border-l-4 border-yellow-500 max-w-lg w-full shadow-2xl">
                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-xl font-bold text-yellow-500">SECURITY CHECK</h2>
                    <span id="quiz-progress" class="font-mono text-gray-400">Q: 1/5</span>
                </div>
                
                <div class="mb-6">
                    <p id="quiz-question" class="text-md md:text-lg text-white font-medium leading-relaxed">Loading Question...</p>
                </div>

                <div id="quiz-options" class="grid gap-2">
                    <!-- Options injected here -->
                </div>

                <div id="quiz-feedback" class="mt-4 text-center hidden font-bold"></div>
            </div>
        </div>

        <!-- VIEW: QUIZ RESULT -->
        <div id="view-quiz-result" class="absolute inset-0 bg-gray-900 z-20 hidden flex flex-col items-center justify-center p-4">
            <div class="bg-gray-800 p-8 rounded-xl border border-gray-600 text-center max-w-md w-full">
                <i id="result-icon" class="fas fa-check-circle text-6xl mb-4 text-green-500"></i>
                <h2 id="result-title" class="text-2xl font-bold mb-2">ACCESS GRANTED</h2>
                <p class="text-gray-400 mb-6">Score: <span id="result-score" class="text-white font-bold text-xl">4/5</span></p>
                <p id="result-msg" class="text-sm text-yellow-500 mb-6">Proceed to excavation site.</p>
                
                <div id="instructions-panel" class="text-left bg-gray-900 p-4 rounded mb-6 text-sm hidden">
                    <h4 class="text-white font-bold mb-2 border-b border-gray-700 pb-1">MISSION BRIEFING:</h4>
                    <div id="game-instructions" class="text-gray-300 leading-snug"></div>
                </div>

                <button id="btn-proceed" class="btn-dig px-6 py-3 rounded font-bold text-gray-900 w-full uppercase">Start Mission</button>
            </div>
        </div>

        <!-- VIEW: GAME 1 (LAB) -->
        <div id="view-game1" class="absolute inset-0 bg-gray-900 z-10 hidden p-4 overflow-y-auto">
            <div class="max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                    <h2 class="text-2xl font-bold text-blue-400">Density Lab Analysis</h2>
                    <div class="flex gap-2">
                        <button onclick="lab.toggleGuide()" class="btn-dig px-3 py-1 rounded text-sm text-black font-bold shadow-lg animate-pulse"><i class="fas fa-book"></i> FIELD GUIDE</button>
                        <button onclick="app.returnHome()" class="text-gray-400 hover:text-white px-3 py-1"><i class="fas fa-times"></i> Exit</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Sample Station -->
                    <div class="bg-gray-800 p-4 rounded border border-gray-600">
                        <h3 class="text-lg font-bold text-yellow-500 mb-2">1. Select Sample</h3>
                        <div class="flex gap-4 justify-center mb-4">
                            <div onclick="lab.selectSample(0)" class="sample-rock cursor-pointer p-4 bg-gray-700 rounded hover:bg-gray-600 border-2 border-transparent hover:border-blue-400 transition">
                                <div class="w-16 h-16 bg-gray-400 rounded-full mx-auto mb-2 flex items-center justify-center text-2xl">ðŸª¨</div>
                                <div class="text-center text-xs">Sample A</div>
                            </div>
                            <div onclick="lab.selectSample(1)" class="sample-rock cursor-pointer p-4 bg-gray-700 rounded hover:bg-gray-600 border-2 border-transparent hover:border-blue-400 transition">
                                <div class="w-16 h-16 bg-yellow-100 rounded-full mx-auto mb-2 flex items-center justify-center text-2xl">ðŸ’Ž</div>
                                <div class="text-center text-xs">Sample B</div>
                            </div>
                            <div onclick="lab.selectSample(2)" class="sample-rock cursor-pointer p-4 bg-gray-700 rounded hover:bg-gray-600 border-2 border-transparent hover:border-blue-400 transition">
                                <div class="w-16 h-16 bg-black rounded-full mx-auto mb-2 flex items-center justify-center text-2xl">ðŸŒ‹</div>
                                <div class="text-center text-xs">Sample C</div>
                            </div>
                        </div>
                        <div id="sample-desc" class="text-sm text-gray-300 italic min-h-[3rem]">Select a sample to analyze...</div>
                    </div>

                    <!-- Tools -->
                    <div class="bg-gray-800 p-4 rounded border border-gray-600">
                        <h3 class="text-lg font-bold text-yellow-500 mb-2">2. Measure</h3>
                        
                        <div class="mb-4">
                            <label class="text-xs text-gray-400">ELECTRONIC BALANCE (Mass)</label>
                            <div class="flex items-center gap-2">
                                <div class="bg-black text-green-500 font-mono text-xl p-2 rounded flex-1 text-right"><span id="read-mass">0.0</span> g</div>
                                <button onclick="lab.weigh()" class="btn-secondary px-3 py-2 rounded text-xs">WEIGH</button>
                            </div>
                        </div>

                        <div>
                            <label class="text-xs text-gray-400">GRADUATED CYLINDER (Volume via Displacement)</label>
                            <div class="flex items-center gap-2">
                                <div class="bg-black text-green-500 font-mono text-xl p-2 rounded flex-1 text-right"><span id="read-volume">0.0</span> mL</div>
                                <button onclick="lab.displace()" class="btn-secondary px-3 py-2 rounded text-xs">SUBMERGE</button>
                            </div>
                        </div>
                    </div>

                    <!-- Analysis Computer -->
                    <div class="bg-gray-800 p-4 rounded border border-gray-600 col-span-1 md:col-span-2">
                        <h3 class="text-lg font-bold text-yellow-500 mb-2">3. Field Tablet Calculation</h3>
                        <p class="text-xs text-gray-400 mb-2">Formula: Density = Mass / Volume</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                            <div>
                                <label class="text-xs text-gray-400">Calculated Density (g/mL)</label>
                                <input type="number" id="input-density" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-white font-mono" placeholder="?.?">
                            </div>
                            <div>
                                <label class="text-xs text-gray-400">Identification</label>
                                <select id="input-id" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-white">
                                    <option value="">-- Identify Mineral --</option>
                                    <option value="pyrite">Pyrite</option>
                                    <option value="quartz">Quartz</option>
                                    <option value="gold">Gold</option>
                                    <option value="pumice">Pumice</option>
                                    <option value="obsidian">Obsidian</option>
                                </select>
                            </div>
                            <button onclick="lab.submit()" class="btn-dig px-4 py-2 rounded text-black font-bold h-10">SUBMIT LOG</button>
                        </div>
                        <div id="lab-feedback" class="mt-2 text-sm font-bold min-h-[1.5rem]"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL: FIELD GUIDE -->
        <div id="modal-guide" class="absolute inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4">
            <div class="bg-gray-800 border-2 border-yellow-500 rounded-lg p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-start mb-4 border-b border-gray-600 pb-2">
                    <h2 class="text-2xl font-bold text-yellow-500">FIELD GUIDE & LAB MANUAL</h2>
                    <button onclick="lab.toggleGuide()" class="text-gray-400 hover:text-white text-xl"><i class="fas fa-times"></i></button>
                </div>

                <div class="mb-6">
                    <h3 class="text-lg font-bold text-blue-300 mb-2">How to Identify Samples</h3>
                    <ol class="list-decimal pl-5 text-gray-300 space-y-1 text-sm">
                        <li><strong>Select a Sample:</strong> Click on one of the 3 unknown rocks (A, B, or C).</li>
                        <li><strong>Weigh It:</strong> Click "WEIGH" to get the Mass (grams).</li>
                        <li><strong>Submerge It:</strong> Click "SUBMERGE" to find the Volume (mL) based on how much water it moves.</li>
                        <li><strong>Calculate Density:</strong> Use the formula <code>Density = Mass Ã· Volume</code>.</li>
                        <li><strong>Identify:</strong> Match your calculated Density to the "Field Notes" below to find the name.</li>
                        <li><strong>Submit:</strong> Enter the number and name in the Field Tablet and click Submit.</li>
                    </ol>
                </div>

                <div>
                    <h3 class="text-lg font-bold text-blue-300 mb-2">Field Notes: Mineral Reference</h3>
                    <table class="w-full lab-table text-gray-200">
                        <thead>
                            <tr>
                                <th>Mineral Name</th>
                                <th>Exp. Density</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Pumice</strong></td>
                                <td>&lt; 1.0</td>
                                <td>Very light, gray, full of holes (vesicular). Floats in water.</td>
                            </tr>
                            <tr>
                                <td><strong>Obsidian</strong></td>
                                <td>2.5</td>
                                <td>Dark black, shiny, glassy texture. Sharp edges.</td>
                            </tr>
                             <tr>
                                <td><strong>Quartz</strong></td>
                                <td>2.6</td>
                                <td>Glassy luster, often clear or white. Hardness 7.</td>
                            </tr>
                            <tr>
                                <td><strong>Pyrite</strong></td>
                                <td>5.0</td>
                                <td>"Fool's Gold". Metallic luster, brassy yellow, cubic crystals.</td>
                            </tr>
                            <tr>
                                <td><strong>Gold</strong></td>
                                <td>19.3</td>
                                <td>Very heavy for its size. Metallic yellow. Malleable.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- VIEW: GENERIC CANVAS GAME (For Games 2, 3, 4) -->
        <div id="view-game-canvas" class="absolute inset-0 bg-black z-10 hidden flex flex-col">
            <div class="bg-gray-900 p-2 flex justify-between items-center border-b border-gray-700">
                <div class="font-mono text-yellow-500 text-lg">SCORE: <span id="game-score">0</span></div>
                <div class="font-bold text-white" id="game-title-display">GAME TITLE</div>
                <button onclick="activeGameInstance.endGame()" class="bg-red-600 text-white px-3 py-1 rounded text-xs">ABORT</button>
            </div>
            <div class="flex-1 relative overflow-hidden" id="canvas-container">
                <canvas id="gameCanvas" class="w-full h-full block"></canvas>
                <!-- Touch Controls Overlay for specific games -->
                <div id="touch-controls" class="absolute bottom-4 left-0 w-full flex justify-around pointer-events-none hidden">
                    <button id="btn-left" class="pointer-events-auto bg-white/20 p-4 rounded-full w-16 h-16 backdrop-blur-sm active:bg-white/40"><i class="fas fa-arrow-left text-white"></i></button>
                    <button id="btn-action" class="pointer-events-auto bg-yellow-500/50 p-4 rounded-full w-20 h-20 backdrop-blur-sm active:bg-yellow-500/80 border-2 border-yellow-300"></button>
                    <button id="btn-right" class="pointer-events-auto bg-white/20 p-4 rounded-full w-16 h-16 backdrop-blur-sm active:bg-white/40"><i class="fas fa-arrow-right text-white"></i></button>
                </div>
            </div>
        </div>

        <!-- VIEW: GAME OVER -->
        <div id="view-game-over" class="absolute inset-0 bg-black/90 z-30 hidden flex flex-col items-center justify-center">
            <h2 class="text-4xl text-red-500 font-bold mb-4 font-mono">SESSION ENDED</h2>
            <div class="bg-gray-800 p-8 rounded-lg border-2 border-gray-600 text-center w-full max-w-md">
                <p class="text-gray-400 mb-2">FINAL SCORE</p>
                <div id="final-score-display" class="text-5xl text-white font-mono font-bold mb-6">1250</div>
                <div id="game-feedback" class="text-yellow-500 text-sm mt-2 font-mono"></div>
                <button onclick="app.returnHome()" class="btn-dig w-full py-3 rounded text-xl font-bold uppercase mt-6">Return to Map</button>
            </div>
        </div>

    </main>

    <!-- LOGIC -->
    <script>
        // --- DATA: QUESTION BANKS ---
        // Questions derived strictly from user's PDF, mixed Recall (Level 1) and Analysis (Level 2)
        const questionBanks = {
            2: [ // Minerals (Mixed)
                { q: "What is the hardest mineral on the Mohs scale?", a: "Diamond", wrong: ["Talc", "Quartz", "Topaz"] },
                { q: "You find a mineral that peels off in very thin, flat sheets. Which property are you observing?", a: "Cleavage", wrong: ["Fracture", "Hardness", "Streak"] },
                { q: "What property describes a mineral splitting easily along a flat surface?", a: "Cleavage", wrong: ["Fracture", "Luster", "Streak"] },
                { q: "A mineral scratches a penny (3.5) but gets scratched by glass (5.5). What is its estimated hardness?", a: "Between 3.5 and 5.5", wrong: ["Less than 2", "Greater than 7", "Exactly 10"] },
                { q: "What is the color of a mineral's powder called?", a: "Streak", wrong: ["Luster", "Color", "Fracture"] },
                { q: "Why is coal NOT considered a mineral?", a: "It is Organic (from plants)", wrong: ["It is too soft", "It is too black", "It burns"] },
                { q: "You have a yellow sample. To decide if it is Gold or Pyrite, what is the best test?", a: "Streak Test", wrong: ["Taste Test", "Smell Test", "Weighing it"] },
                { q: "What describes how light reflects from a mineral's surface?", a: "Luster", wrong: ["Streak", "Texture", "Density"] },
                { q: "If a mineral breaks into jagged, uneven chunks like quartz, what property does it exhibit?", a: "Fracture", wrong: ["Cleavage", "Luster", "Magnetism"] },
                { q: "A jeweler wants a gem that won't scratch. Which mineral should they choose?", a: "Corundum (9) or Diamond (10)", wrong: ["Talc (1)", "Gypsum (2)", "Calcite (3)"] },
                { q: "What is the softest mineral (Hardness 1)?", a: "Talc", wrong: ["Gypsum", "Calcite", "Fluorite"] },
                { q: "Why do minerals like Halite form cubes?", a: "Internal Crystal Structure", wrong: ["Random chance", "Temperature", "Gravity"] },
                { q: "If you found a clear mineral that bubbles when acid is placed on it, it is likely:", a: "Calcite", wrong: ["Quartz", "Diamond", "Gold"] },
                { q: "Density is defined as:", a: "Mass divided by Volume", wrong: ["Weight times Size", "Volume divided by Mass", "Mass plus Volume"] },
                { q: "Why is 'Color' the least reliable property?", a: "One mineral can come in many colors", wrong: ["Colors fade", "Rocks are only grey", "Eyesight varies"] },
                { q: "Which tool differentiates Orthoclase (6) and Quartz (7)?", a: "A Steel File (6.5)", wrong: ["A Fingernail (2.5)", "A Penny (3.5)", "Paper"] },
                { q: "Minerals must be:", a: "Inorganic Solid", wrong: ["Organic Liquid", "Man-made Gas", "Living Tissue"] },
                { q: "How many minerals make up the majority of Earth's crust?", a: "20", wrong: ["5,000", "100", "5"] },
                { q: "What type of luster does silver have?", a: "Metallic", wrong: ["Earthy", "Glassy", "Silky"] },
                { q: "A crystal structure means particles line up in:", a: "A repeating pattern", wrong: ["Random chaos", "Liquid form", "Soft layers"] }
            ],
            3: [ // Rock Cycle (Mixed)
                { q: "Igneous rock forms from:", a: "Magma or Lava", wrong: ["Sediment", "Heat and Pressure", "Fossils"] },
                { q: "If a sedimentary rock is pushed deep underground, heats up, and melts, what will it become next?", a: "Magma", wrong: ["Metamorphic Rock", "Sediment", "A Fossil"] },
                { q: "Magma is found:", a: "Inside the Earth", wrong: ["On the surface", "In the air", "In the ocean"] },
                { q: "Why do Extrusive Igneous rocks have very small crystals?", a: "Lava cooled quickly", wrong: ["They cooled slowly", "They were squeezed", "They are made of sand"] },
                { q: "You find a rock with distinct bands (layers) of minerals. It likely formed from:", a: "Heat and Pressure (Metamorphic)", wrong: ["Cooling Lava", "Settling Sediment", "Evaporation"] },
                { q: "The first step in sedimentary formation is:", a: "Weathering", wrong: ["Deposition", "Compaction", "Cementation"] },
                { q: "What process must occur for a Metamorphic rock to become Sediment?", a: "Weathering and Erosion", wrong: ["Melting", "Heat and Pressure", "Cooling"] },
                { q: "Why are fossils rarely found in Igneous rocks?", a: "The magma would melt them", wrong: ["Animals avoid volcanoes", "Igneous is too hard", "They escape"] },
                { q: "Sediment settling out of water or wind is called:", a: "Deposition", wrong: ["Erosion", "Weathering", "Melting"] },
                { q: "If you see a rock with large, visible crystals (like Granite), where did it form?", a: "Deep underground (Intrusive)", wrong: ["On the surface (Extrusive)", "In a river", "In the ocean"] },
                { q: "Which step in sedimentary rock formation acts like glue?", a: "Cementation", wrong: ["Erosion", "Deposition", "Compaction"] },
                { q: "Organic sedimentary rock forms from:", a: "Remains of plants/animals", wrong: ["Rock fragments", "Chemicals", "Lava"] },
                { q: "Obsidian is smooth like glass because:", a: "It cooled instantly", wrong: ["It was polished", "It formed underwater", "It is plastic"] },
                { q: "Limestone turns into what metamorphic rock?", a: "Marble", wrong: ["Gneiss", "Slate", "Quartzite"] },
                { q: "Metamorphic rock forms from:", a: "Heat and Pressure", wrong: ["Melting", "Erosion", "Cooling"] },
                { q: "If a rock is described as 'Foliated', what texture are you looking for?", a: "Aligned layers/bands", wrong: ["Random grains", "Gas bubbles", "Glassy surface"] },
                { q: "Granite turns into what metamorphic rock?", a: "Gneiss", wrong: ["Marble", "Slate", "Sandstone"] },
                { q: "Why is Pumice the only rock that floats?", a: "It is full of gas bubbles", wrong: ["It is wood", "It is hollow", "It is magnetic"] },
                { q: "Chemical sedimentary rocks like Halite form when:", a: "Water evaporates", wrong: ["Magma cools", "Rocks squeeze", "Plants die"] },
                { q: "Can an Igneous rock become another Igneous rock?", a: "Yes, if it melts and re-cools", wrong: ["No", "Only if it erodes", "Never"] }
            ],
            4: [ // Drill/Hardness (Mixed)
                { q: "What is the hardest natural substance?", a: "Diamond", wrong: ["Steel", "Titanium", "Granite"] },
                { q: "A drill bit made of Apatite (5) tries to bore through Quartz (7). What happens?", a: "The drill bit breaks", wrong: ["The Quartz breaks", "They both break", "It drills slowly"] },
                { q: "A fingernail has a hardness of about:", a: "2.5", wrong: ["5.0", "7.0", "1.0"] },
                { q: "You need to scratch a Corundum (9) sample. What is the ONLY mineral that can do it?", a: "Diamond (10)", wrong: ["Topaz (8)", "Another Corundum", "Quartz (7)"] },
                { q: "If Calcite (3) rubs against Fluorite (4), which one gets scratched?", a: "Calcite", wrong: ["Fluorite", "Neither", "Both"] },
                { q: "What is the mineral name for salt?", a: "Halite", wrong: ["Gypsum", "Calcite", "Quartz"] },
                { q: "Why can't you use a steel knife (5.5) to test if a gem is Topaz (8)?", a: "Topaz is harder than the knife", wrong: ["Knife is too sharp", "Steel is too soft for anything", "Topaz melts steel"] },
                { q: "A fingernail (2.5) can scratch which of these minerals?", a: "Gypsum (2)", wrong: ["Calcite (3)", "Fluorite (4)", "Apatite (5)"] },
                { q: "Gypsum is used for:", a: "Wallboard/Plaster", wrong: ["Jewelry", "Roads", "Glass"] },
                { q: "Which common object is closest in hardness to Apatite (5)?", a: "Glass Plate / Knife (5.5)", wrong: ["Penny (3.5)", "Fingernail (2.5)", "Diamond Ring"] },
                { q: "Why is Talc (1) suitable for baby powder?", a: "It is extremely soft", wrong: ["It is hard", "It dissolves", "It is magnetic"] },
                { q: "Which mineral is harder: Orthoclase (6) or a Glass Plate (5.5)?", a: "Orthoclase", wrong: ["Glass Plate", "Equal", "Depends on weather"] },
                { q: "To protect a watch face, you should use glass made of:", a: "Quartz (7) or Sapphire (9)", wrong: ["Talc (1)", "Plastic (2)", "Calcite (3)"] },
                { q: "Why are most drill bits tipped with Diamond?", a: "To cut through any softer rock", wrong: ["To look expensive", "To conduct heat", "To avoid rust"] },
                { q: "Can a streak plate (Porcelain ~7) test the streak of Topaz (8)?", a: "No, Topaz scratches the plate", wrong: ["Yes, always", "Only if wet", "Maybe"] },
                { q: "You find a clear crystal. It scratches Gypsum but is scratched by Calcite. Its hardness is:", a: "Around 2.5", wrong: ["Around 5", "Around 1", "Around 10"] },
                { q: "What mineral is used in pencils?", a: "Graphite", wrong: ["Lead", "Coal", "Obsidian"] },
                { q: "Can a penny scratch Fluorite (4)?", a: "No", wrong: ["Yes", "Maybe", "Only if hot"] },
                { q: "Which mineral can scratch Quartz (7)?", a: "Topaz (8)", wrong: ["Feldspar (6)", "Apatite (5)", "Calcite (3)"] },
                { q: "The Mohs scale ranks minerals from:", a: "1 to 10", wrong: ["1 to 100", "A to Z", "Soft to Heavy"] }
            ]
        };

        const instructions = {
            2: `<ul class="list-disc pl-5 text-left text-gray-300 space-y-2">
                    <li><strong>Goal:</strong> Analyze mineral properties.</li>
                    <li><strong>Look:</strong> Read the description on the rock (e.g., "Peels in sheets").</li>
                    <li><strong>Action:</strong> Tap the correct <strong>CATEGORY BIN</strong> below (e.g., "Cleavage").</li>
                    <li><strong>Win:</strong> Prove you know the definitions!</li>
                </ul>`,
            3: `<ul class="list-disc pl-5 text-left text-gray-300 space-y-2">
                    <li><strong>Goal:</strong> Survive the rock cycle!</li>
                    <li><strong>Action:</strong> Tap screen to JUMP.</li>
                    <li><strong>Prepare:</strong> Wait for the "3-2-1" countdown.</li>
                    <li><strong>Collect:</strong> Yellow Orbs for points. Avoid Walls.</li>
                </ul>`,
            4: `<ul class="list-disc pl-5 text-left text-gray-300 space-y-2">
                    <li><strong>Goal:</strong> Drill efficiently!</li>
                    <li><strong>Rule:</strong> Drill bit must be <strong>HARDER</strong> than the rock layer.</li>
                    <li><strong>Warning:</strong> If Drill is <strong>TOO HARD</strong> (>3 levels difference), the sample SHATTERS!</li>
                    <li><strong>Sweet Spot:</strong> Keep your drill just 1-3 levels above the rock hardness.</li>
                </ul>`
        };

        // --- APP STATE ---
        const app = {
            state: {
                game1Complete: false,
                game2Score: 0,
                game3Score: 0,
                game4Score: 0,
                currentGame: null,
            },

            init: function() {
                // Load from localStorage if available
                const saved = localStorage.getItem('cloverGeoSave');
                if(saved) {
                    const parsed = JSON.parse(saved);
                    this.state = {...this.state, ...parsed};
                    this.updateMapUI();
                }
            },

            save: function() {
                localStorage.setItem('cloverGeoSave', JSON.stringify(this.state));
                this.updateMapUI();
            },

            updateMapUI: function() {
                // Update badges and locks
                const badgeLab = document.getElementById('badge-lab');
                if(this.state.game1Complete) {
                    badgeLab.innerHTML = "STATUS: COMPLETE";
                    badgeLab.className = "text-xs font-mono bg-green-900 px-2 py-1 rounded text-green-400";
                    
                    // Unlock others
                    ['game2', 'game3', 'game4'].forEach(id => {
                        const card = document.getElementById(`card-${id}`);
                        card.classList.remove('zone-locked');
                        card.querySelector('.lock-icon').classList.remove('fa-lock');
                        card.querySelector('.lock-icon').classList.add('fa-play-circle', 'text-green-500');
                    });
                }

                // Update scores
                document.getElementById('score-g2').innerText = this.state.game2Score;
                document.getElementById('score-g3').innerText = this.state.game3Score;
                document.getElementById('score-g4').innerText = this.state.game4Score;
            },

            launchGame: function(id) {
                if(id > 1 && !this.state.game1Complete) {
                    alert("ACCESS DENIED: You must complete the Field Lab analysis first.");
                    return;
                }
                
                this.state.currentGame = id;

                if(id === 1) {
                    document.getElementById('view-dashboard').classList.add('hidden');
                    document.getElementById('view-game1').classList.remove('hidden');
                    lab.reset();
                } else {
                    // Start Quiz
                    quiz.start(id);
                }
            },

            returnHome: function() {
                // Hide all views
                document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
                document.getElementById('view-dashboard').classList.remove('hidden');
                document.getElementById('modal-guide').classList.add('hidden'); // Ensure modal is closed
                
                // Stop any running game loops
                if(window.activeGameInstance) {
                    window.activeGameInstance.stop();
                    window.activeGameInstance = null;
                }

                this.save();
            }
        };

        // --- LAB LOGIC (GAME 1) ---
        const lab = {
            samples: [
                { name: "Pumice", mass: 15.0, volume: 25.0, density: 0.6, type: "pumice", desc: "Light gray, full of holes (vesicular)." }, // Floats
                { name: "Pyrite", mass: 50.0, volume: 10.0, density: 5.0, type: "pyrite", desc: "Brass-yellow, metallic luster, cubic crystals." },
                { name: "Obsidian", mass: 30.0, volume: 12.0, density: 2.5, type: "obsidian", desc: "Black, glassy texture, conchoidal fracture." }
            ],
            currentSampleIndex: null,
            measuredMass: false,
            measuredVol: false,
            tries: 0,

            reset: function() {
                this.currentSampleIndex = null;
                this.measuredMass = false;
                this.measuredVol = false;
                this.tries = 0;
                document.getElementById('read-mass').innerText = "0.0";
                document.getElementById('read-volume').innerText = "0.0";
                document.getElementById('input-density').value = "";
                document.getElementById('input-id').value = "";
                document.getElementById('sample-desc').innerText = "Select a sample to analyze...";
                document.getElementById('lab-feedback').innerText = "";
            },

            toggleGuide: function() {
                const modal = document.getElementById('modal-guide');
                modal.classList.toggle('hidden');
            },

            selectSample: function(idx) {
                this.currentSampleIndex = idx;
                this.measuredMass = false;
                this.measuredVol = false;
                document.getElementById('read-mass').innerText = "0.0";
                document.getElementById('read-volume').innerText = "0.0";
                document.getElementById('sample-desc').innerText = this.samples[idx].desc;
                
                // Visual selection highlight
                document.querySelectorAll('.sample-rock').forEach((el, i) => {
                    el.classList.toggle('border-blue-500', i === idx);
                });
            },

            weigh: function() {
                if(this.currentSampleIndex === null) return;
                document.getElementById('read-mass').innerText = this.samples[this.currentSampleIndex].mass.toFixed(1);
                this.measuredMass = true;
            },

            displace: function() {
                if(this.currentSampleIndex === null) return;
                // Animation simulation
                document.getElementById('read-volume').innerText = "...";
                setTimeout(() => {
                    document.getElementById('read-volume').innerText = this.samples[this.currentSampleIndex].volume.toFixed(1);
                    this.measuredVol = true;
                }, 500);
            },

            submit: function() {
                if(this.currentSampleIndex === null) {
                    this.feedback("No sample selected.", "text-red-500");
                    return;
                }
                const userDensity = parseFloat(document.getElementById('input-density').value);
                const userId = document.getElementById('input-id').value;
                const correct = this.samples[this.currentSampleIndex];

                if(!userDensity || !userId) {
                    this.feedback("Incomplete data.", "text-red-500");
                    return;
                }

                // Check Density (allow 0.1 margin)
                const densDiff = Math.abs(userDensity - correct.density);
                if(densDiff > 0.2) {
                    this.feedback("Density calculation incorrect. Remember: Mass / Volume.", "text-red-500");
                    return;
                }

                if(userId !== correct.type) {
                    this.feedback("Incorrect Identification based on properties.", "text-red-500");
                    return;
                }

                // Success
                this.tries++;
                if(this.tries >= 3) {
                    alert("EXCELLENT WORK! Lab work complete. You are cleared for the field.");
                    app.state.game1Complete = true;
                    app.returnHome();
                } else {
                    this.feedback("Correct! Select another sample. Need " + (3-this.tries) + " more.", "text-green-500");
                    // Disable current sample visually
                    document.querySelectorAll('.sample-rock')[this.currentSampleIndex].classList.add('opacity-50', 'pointer-events-none');
                    this.currentSampleIndex = null;
                }
            },

            feedback: function(msg, colorClass) {
                const el = document.getElementById('lab-feedback');
                el.innerText = msg;
                el.className = `mt-2 text-sm font-bold min-h-[1.5rem] ${colorClass}`;
            }
        };

        // --- QUIZ ENGINE ---
        const quiz = {
            questions: [],
            score: 0,
            currentQIndex: 0,
            targetGameId: null,

            start: function(gameId) {
                this.targetGameId = gameId;
                this.score = 0;
                this.currentQIndex = 0;
                
                // Get 5 random questions
                const pool = [...questionBanks[gameId]];
                this.questions = [];
                for(let i=0; i<5; i++) {
                    const r = Math.floor(Math.random() * pool.length);
                    this.questions.push(pool[r]);
                    pool.splice(r, 1);
                }

                document.getElementById('view-dashboard').classList.add('hidden');
                document.getElementById('view-quiz').classList.remove('hidden');
                this.renderQuestion();
            },

            renderQuestion: function() {
                const qData = this.questions[this.currentQIndex];
                document.getElementById('quiz-progress').innerText = `Q: ${this.currentQIndex + 1}/5`;
                document.getElementById('quiz-question').innerText = qData.q;
                
                const feedbackEl = document.getElementById('quiz-feedback');
                feedbackEl.classList.add('hidden');
                
                // Shuffle answers
                let answers = [{txt: qData.a, correct: true}, ...qData.wrong.map(w => ({txt: w, correct: false}))];
                answers.sort(() => Math.random() - 0.5);

                const optsContainer = document.getElementById('quiz-options');
                optsContainer.innerHTML = '';
                
                answers.forEach(ans => {
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left p-3 rounded bg-gray-700 hover:bg-gray-600 border border-gray-600 transition font-mono text-sm md:text-base";
                    btn.innerText = ans.txt;
                    btn.onclick = () => this.handleAnswer(ans.correct, btn);
                    optsContainer.appendChild(btn);
                });
            },

            handleAnswer: function(isCorrect, btnElement) {
                // Disable all buttons
                const btns = document.getElementById('quiz-options').children;
                for(let b of btns) b.disabled = true;

                const feedbackEl = document.getElementById('quiz-feedback');
                feedbackEl.classList.remove('hidden');

                if(isCorrect) {
                    this.score++;
                    btnElement.classList.add('bg-green-600', 'border-green-400');
                    feedbackEl.innerText = "CORRECT";
                    feedbackEl.className = "mt-4 text-center font-bold text-green-500";
                } else {
                    btnElement.classList.add('bg-red-600', 'border-red-400');
                    feedbackEl.innerText = `INCORRECT. Answer: ${this.questions[this.currentQIndex].a}`;
                    feedbackEl.className = "mt-4 text-center font-bold text-red-500";
                }

                setTimeout(() => {
                    this.currentQIndex++;
                    if(this.currentQIndex < 5) {
                        this.renderQuestion();
                    } else {
                        this.endQuiz();
                    }
                }, 1500);
            },

            endQuiz: function() {
                document.getElementById('view-quiz').classList.add('hidden');
                document.getElementById('view-quiz-result').classList.remove('hidden');
                
                const passed = this.score >= 3;
                document.getElementById('result-score').innerText = `${this.score}/5`;
                
                const title = document.getElementById('result-title');
                const icon = document.getElementById('result-icon');
                const msg = document.getElementById('result-msg');
                const btn = document.getElementById('btn-proceed');
                const instrPanel = document.getElementById('instructions-panel');

                if(passed) {
                    title.innerText = "ACCESS GRANTED";
                    title.className = "text-2xl font-bold mb-2 text-green-500";
                    icon.className = "fas fa-check-circle text-6xl mb-4 text-green-500";
                    msg.innerText = "Security clearance accepted. Loading simulation...";
                    btn.innerText = "START GAME";
                    btn.onclick = () => {
                        document.getElementById('view-quiz-result').classList.add('hidden');
                        games.start(this.targetGameId);
                    };
                    
                    // Show Instructions
                    instrPanel.classList.remove('hidden');
                    document.getElementById('game-instructions').innerHTML = instructions[this.targetGameId];

                } else {
                    title.innerText = "ACCESS DENIED";
                    title.className = "text-2xl font-bold mb-2 text-red-500";
                    icon.className = "fas fa-times-circle text-6xl mb-4 text-red-500";
                    msg.innerText = "Minimum accuracy 3/5 required. Review notes and retry.";
                    btn.innerText = "RETURN TO MAP";
                    btn.onclick = () => app.returnHome();
                    instrPanel.classList.add('hidden');
                }
            }
        };

        // --- GAME ENGINES (CANVAS) ---
        const games = {
            start: function(gameId) {
                document.getElementById('view-game-canvas').classList.remove('hidden');
                const canvas = document.getElementById('gameCanvas');
                const ctx = canvas.getContext('2d');
                
                // Resize Canvas
                const container = document.getElementById('canvas-container');
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;

                // Title
                const titles = {2: "PROP-ANALYZER", 3: "MAGMA RUN", 4: "MOHS DRILL"};
                document.getElementById('game-title-display').innerText = titles[gameId];

                // Controls
                const touchControls = document.getElementById('touch-controls');
                const btnLeft = document.getElementById('btn-left');
                const btnRight = document.getElementById('btn-right');
                const btnAction = document.getElementById('btn-action');

                // Clear previous listeners (hacky but works for simple app)
                const newLeft = btnLeft.cloneNode(true); btnLeft.parentNode.replaceChild(newLeft, btnLeft);
                const newRight = btnRight.cloneNode(true); btnRight.parentNode.replaceChild(newRight, btnRight);
                const newAction = btnAction.cloneNode(true); btnAction.parentNode.replaceChild(newAction, btnAction);

                if(gameId === 2) {
                    window.activeGameInstance = new Game2(canvas, newLeft, newRight, newAction);
                    window.activeGameInstance.start();
                } else if(gameId === 3) {
                    window.activeGameInstance = new Game3(canvas, newAction);
                    window.activeGameInstance.start();
                } else if(gameId === 4) {
                    window.activeGameInstance = new Game4(canvas, newLeft, newRight);
                    window.activeGameInstance.start();
                }
            }
        };

        // --- GAME 2: MINERAL ANALYZER (Categorization) ---
        class Game2 {
            constructor(canvas, bL, bR, bA) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.items = [];
                this.score = 0;
                this.running = false;
                this.speed = 1.5;
                this.spawnTimer = 0;
                this.bL = bL; this.bR = bR; this.bA = bA;
                
                // Bins: [L] Cleavage/Fracture, [M] Luster/Streak, [R] Hardness
                // Setup UI controls
                document.getElementById('touch-controls').classList.remove('hidden');
                this.bL.innerHTML = "STRUCT<br><span class='text-xs'>(Cleave)</span>";
                this.bL.className = "pointer-events-auto bg-blue-600 p-2 rounded w-24 h-16 font-bold text-white text-xs text-center leading-tight flex items-center justify-center";
                
                this.bA.classList.remove('hidden');
                this.bA.innerHTML = "VISUAL<br><span class='text-xs'>(Luster)</span>";
                this.bA.className = "pointer-events-auto bg-yellow-600 p-2 rounded w-24 h-16 font-bold text-white text-xs text-center leading-tight flex items-center justify-center border-none";
                
                this.bR.innerHTML = "TEST<br><span class='text-xs'>(Hardness)</span>";
                this.bR.className = "pointer-events-auto bg-purple-600 p-2 rounded w-24 h-16 font-bold text-white text-xs text-center leading-tight flex items-center justify-center";

                this.categories = ["structure", "visual", "test"];

                // Inputs
                this.bL.onclick = () => this.sort("structure");
                this.bA.onclick = () => this.sort("visual");
                this.bR.onclick = () => this.sort("test");
            }

            start() {
                this.running = true;
                this.loop();
            }

            stop() { this.running = false; }
            endGame() { this.stop(); showGameOver(this.score, 2); }

            sort(choice) {
                if(this.items.length > 0) {
                    const item = this.items[0];
                    if(item.cat === choice) {
                        this.score += 100;
                        this.items.shift();
                        this.speed += 0.1;
                    } else {
                        this.endGame();
                    }
                }
            }

            loop() {
                if(!this.running) return;
                
                this.spawnTimer++;
                if(this.spawnTimer > 180) { // Slower spawn for reading text
                    this.spawnTimer = 0;
                    this.spawnItem();
                }

                // Move items
                for(let i=0; i<this.items.length; i++) {
                    this.items[i].y += this.speed;
                    if(this.items[i].y > this.canvas.height - 100) {
                        this.endGame();
                        return;
                    }
                }

                // Draw
                this.ctx.fillStyle = "#111827";
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                // Draw Bins
                this.ctx.fillStyle = "#2563eb"; // Blue
                this.ctx.fillRect(0, this.canvas.height-20, this.canvas.width/3, 20);
                this.ctx.fillStyle = "#ca8a04"; // Yellow
                this.ctx.fillRect(this.canvas.width/3, this.canvas.height-20, this.canvas.width/3, 20);
                this.ctx.fillStyle = "#9333ea"; // Purple
                this.ctx.fillRect(2*this.canvas.width/3, this.canvas.height-20, this.canvas.width/3, 20);

                // Draw Items
                this.items.forEach(item => {
                    this.ctx.fillStyle = "#374151";
                    this.ctx.strokeStyle = "white";
                    this.ctx.lineWidth = 2;
                    this.ctx.fillRect(this.canvas.width/2 - 100, item.y, 200, 60);
                    this.ctx.strokeRect(this.canvas.width/2 - 100, item.y, 200, 60);
                    
                    this.ctx.fillStyle = "white";
                    this.ctx.font = "14px sans-serif";
                    this.ctx.textAlign = "center";
                    this.ctx.fillText(item.txt, this.canvas.width/2, item.y + 35);
                });

                document.getElementById('game-score').innerText = this.score;
                requestAnimationFrame(() => this.loop());
            }

            spawnItem() {
                const pool = [
                    {txt: "Breaks in flat sheets", cat: "structure"},
                    {txt: "Fractures unevenly", cat: "structure"},
                    {txt: "Reflects light like metal", cat: "visual"},
                    {txt: "Red powder streak", cat: "visual"},
                    {txt: "Scratches glass (7)", cat: "test"},
                    {txt: "Fingernail scratches it", cat: "test"},
                    {txt: "Glassy (Vitreous) shine", cat: "visual"},
                    {txt: "Perfect cubic shape", cat: "structure"}
                ];
                const t = pool[Math.floor(Math.random() * pool.length)];
                this.items.push({...t, y: -60});
            }
        }

        // --- GAME 3: MAGMA RUN (Runner) ---
        class Game3 {
            constructor(canvas, bA) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.player = { y: canvas.height/2, vy: 0, state: "Magma" };
                this.obstacles = [];
                this.score = 0;
                this.running = false;
                this.countingDown = false;
                this.speed = 3;
                
                // Controls
                document.getElementById('touch-controls').classList.remove('hidden');
                document.getElementById('btn-left').classList.add('hidden');
                document.getElementById('btn-right').classList.add('hidden');
                bA.classList.remove('hidden');
                bA.innerHTML = "JUMP";
                
                // Jump/Tap
                const jump = () => { if(this.running) this.player.vy = -8; };
                bA.onclick = jump;
                canvas.onclick = jump;
            }

            start() {
                this.countingDown = true;
                let count = 3;
                
                const countLoop = () => {
                    this.ctx.fillStyle = "#111827";
                    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                    
                    this.ctx.fillStyle = "#ef4444";
                    this.ctx.font = "bold 80px sans-serif";
                    this.ctx.textAlign = "center";
                    this.ctx.fillText(count > 0 ? count : "ERUPT!", this.canvas.width/2, this.canvas.height/2);
                    
                    if(count > 0) {
                        count--;
                        setTimeout(countLoop, 1000);
                    } else {
                        setTimeout(() => {
                            this.countingDown = false;
                            this.running = true;
                            this.loop();
                        }, 500);
                    }
                };
                countLoop();
            }
            
            stop() { this.running = false; }
            endGame() { this.stop(); showGameOver(this.score, 3); }

            loop() {
                if(!this.running) return;

                // Physics
                this.player.vy += 0.4; // Gravity
                this.player.y += this.player.vy;
                this.speed += 0.001;

                // Bounds
                if(this.player.y > this.canvas.height || this.player.y < 0) {
                    this.endGame();
                    return;
                }

                // Spawn Obstacles (Bad) & Powerups (Good)
                if(Math.random() < 0.02) {
                    this.obstacles.push({
                        x: this.canvas.width,
                        y: Math.random() * (this.canvas.height - 100) + 50,
                        type: Math.random() > 0.7 ? "good" : "bad",
                        label: Math.random() > 0.7 ? "Heat" : "Wall"
                    });
                }

                // Move & Collision
                for(let i=this.obstacles.length-1; i>=0; i--) {
                    let o = this.obstacles[i];
                    o.x -= this.speed;
                    
                    // Collision
                    const dx = o.x - 50; 
                    const dy = o.y - this.player.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    
                    if(dist < 30) {
                        if(o.type === "bad") {
                            this.endGame();
                            return;
                        } else {
                            this.score += 50;
                            this.obstacles.splice(i, 1);
                        }
                    } else if (o.x < -20) {
                        this.obstacles.splice(i, 1);
                        if(o.type === "bad") this.score += 10;
                    }
                }

                // Draw
                this.ctx.fillStyle = "#111827";
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                // Player
                this.ctx.fillStyle = "#ef4444";
                this.ctx.beginPath();
                this.ctx.arc(50, this.player.y, 15, 0, Math.PI*2);
                this.ctx.fill();

                // Obstacles
                this.obstacles.forEach(o => {
                    this.ctx.fillStyle = o.type === "good" ? "#fbbf24
